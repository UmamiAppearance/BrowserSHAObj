<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <meta lang="en">
        <title>104 105</title>
        <script type="module">

            import BrowserSHAObj from "../src/BrowserSHAObj.js";
            

            window.makeTests = async () => {

                function makeError(input, output, expected, unit) {
                    return {
                        input: input,
                        output: output,
                        expected: expected,
                        unit: unit
                    }
                }

                const strInput = "Hello World!";
                const testInput = {
                    str: strInput,
                    typed: new TextEncoder().encode(strInput),
                    buffer: new TextEncoder().encode(strInput).buffer
                };

                const expectedOutputs = {
                    "SHA-1":   "2ef7bde608ce5404e97d5f042f95f89f1c232871",
                    "SHA-256": "7f83b1657ff1fc53b92dc18148a1d65dfc2d4b1fa3d677284addd200126d9069",
                    "SHA-384": "bfd76c0ebbd006fee583410547c1887b0292be76d582d96c242d2a792723e3fd6fd061f9d5cfd13b8f961358e6adba4a",
                    "SHA-512": "861844d6704e8573fec34d967e20bcfef3d424cf48be04e6dc08f2bd58c729743371015ead891cc3cf1c9d34b49264b510751b1ff9e537937bc46b5d6ff4ecc8"
                }

                const results = {
                    tests: 0,
                    errors: 0,
                    errorMessages: new Object()
                }

                let testedRepresentations = false;

                for (const algorithm of Object.keys(expectedOutputs)) {
                    const hashFN = new BrowserSHAObj(algorithm);
                    for (const _type in testInput) {
                        results.tests++;
                        const input = testInput[_type];
                        await hashFN.update(input);
                        const hexDigest = hashFN.toHex();
                        const unit = `${algorithm}-${_type}`;
                        if (hexDigest !== expectedOutputs[algorithm]) {
                            results.errors++;
                            if (!results.errorMessages[unit]) results.errorMessages[unit] = new Object();
                            const inputLog = (_type === "buffer") ? `<buffer of str '${testInput.str}'>` : input;
                            results.errorMessages[unit].hexTest = makeError(inputLog, hexDigest, expectedOutputs[algorithm], _type);
                        }

                        if (!testedRepresentations) {
                            let fnNames = Object.keys(hashFN);
                            fnNames = fnNames.filter(key => Boolean(key.match(/^to/)));
                            for (const base of fnNames) {
                                results.tests++;
                                try {
                                    const repr = hashFN[base]();
                                    if (repr.length < 1) {
                                        results.errors++;
                                        results.errorMessages.repr = `Could not get representation '${base}`;
                                    }
                                }
                                catch(e) {
                                    results.errors++;
                                    results.errorMessages.repr = `${base}, ${e}`;
                                }
                            } 

                            testedRepresentations = true;
                        }
                    }
                }

                return results;
            }



        </script>
    </head>
    <body>
        <p>
            This page is not meant to be opened manually.<br> 
            It is only created for test purposes and is getting opened with a headless browser.<br>
            If you like to make tests run:
        </p>
        <code style="background-color:powderblue; color:midnightblue;padding: 6px;">npm test</code>
        <p>
            from your terminal. Make sure that <i>puppeteer</i> is installed.
        </p>
    </body>
</html>
